
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Twilio Intelligence Dashboard</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { background: #fff; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: #fff; padding: 15px; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .stat-value { font-size: 2em; font-weight: bold; color: #2196F3; }
        .controls { background: #fff; padding: 15px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .controls input, .controls select { margin: 5px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        .tabs { margin-bottom: 20px; }
        .tab-button { background: #f0f0f0; border: none; padding: 10px 20px; cursor: pointer; margin-right: 5px; border-radius: 4px 4px 0 0; }
        .tab-button.active { background: #2196F3; color: white; }
        .table-container { background: #fff; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #f8f9fa; font-weight: bold; cursor: pointer; }
        th:hover { background-color: #e9ecef; }
        .pagination { text-align: center; margin-top: 20px; }
        .pagination button { padding: 8px 12px; margin: 0 2px; border: 1px solid #ddd; background: #fff; cursor: pointer; }
        .pagination button.active { background: #2196F3; color: white; }
        .loading { text-align: center; padding: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Twilio Intelligence Dashboard</h1>
            <p>Monitor and analyze your conversation intelligence data</p>
        </div>

        <div class="stats" id="stats"></div>

        <div class="controls">
            <input type="text" id="search" placeholder="Search..." />
            <select id="typeFilter">
                <option value="">All Types</option>
                <option value="text-generation">Text Generation</option>
                <option value="extract">Extract</option>
                <option value="conversation-classify">Classification</option>
            </select>
            <select id="limit">
                <option value="25">25 per page</option>
                <option value="50" selected>50 per page</option>
                <option value="100">100 per page</option>
            </select>
        </div>

        <div class="tabs">
            <button class="tab-button active" onclick="switchTab('transcripts')">Transcripts</button>
            <button class="tab-button" onclick="switchTab('operator_results')">Operator Results</button>
        </div>

        <div class="table-container">
            <div id="loading" class="loading">Loading...</div>
            <table id="dataTable" style="display:none;">
                <thead id="tableHeader"></thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>

        <div class="pagination" id="pagination"></div>
    </div>

    <script>
        let currentTab = 'transcripts';
        let currentPage = 0;
        let currentSort = 'date_created';
        let currentOrder = 'desc';

        async function loadStats() {
            const response = await fetch('/api/stats');
            const stats = await response.json();

            const statsHtml = `
                <div class="stat-card">
                    <div class="stat-value">${stats.total_transcripts}</div>
                    <div>Total Transcripts</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.total_operator_results}</div>
                    <div>Total Results</div>
                </div>
                ${Object.entries(stats.by_type).map(([type, count]) => `
                    <div class="stat-card">
                        <div class="stat-value">${count}</div>
                        <div>${type}</div>
                    </div>
                `).join('')}
            `;

            document.getElementById('stats').innerHTML = statsHtml;
        }

        async function loadData() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('dataTable').style.display = 'none';

            const search = document.getElementById('search').value;
            const typeFilter = document.getElementById('typeFilter').value;
            const limit = document.getElementById('limit').value;

            const params = new URLSearchParams({
                search,
                sort: currentSort,
                order: currentOrder,
                limit,
                offset: currentPage * limit
            });

            if (currentTab === 'operator_results' && typeFilter) {
                params.append('type', typeFilter);
            }

            const response = await fetch(`/api/${currentTab}?${params}`);
            const result = await response.json();

            renderTable(result.data);
            renderPagination(result.total, parseInt(limit));

            document.getElementById('loading').style.display = 'none';
            document.getElementById('dataTable').style.display = 'table';
        }

        function renderTable(data) {
            if (data.length === 0) {
                document.getElementById('tableBody').innerHTML = '<tr><td colspan="100%">No data found</td></tr>';
                return;
            }

            const headers = Object.keys(data[0]);
            document.getElementById('tableHeader').innerHTML = `
                <tr>
                    ${headers.map(header => `
                        <th onclick="sortBy('${header}')">${header} ${currentSort === header ? (currentOrder === 'asc' ? '↑' : '↓') : ''}</th>
                    `).join('')}
                </tr>
            `;

            document.getElementById('tableBody').innerHTML = data.map(row => `
                <tr>
                    ${headers.map(header => `<td>${formatValue(row[header])}</td>`).join('')}
                </tr>
            `).join('');
        }

        function formatValue(value) {
            if (value === null || value === undefined) return '';
            if (typeof value === 'string' && value.length > 100) {
                return value.substring(0, 100) + '...';
            }
            return value;
        }

        function renderPagination(total, limit) {
            const totalPages = Math.ceil(total / limit);
            const pagination = document.getElementById('pagination');

            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }

            let html = '';
            for (let i = 0; i < totalPages; i++) {
                html += `<button onclick="goToPage(${i})" ${i === currentPage ? 'class="active"' : ''}>${i + 1}</button>`;
            }

            pagination.innerHTML = html;
        }

        function switchTab(tab) {
            currentTab = tab;
            currentPage = 0;

            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            document.getElementById('typeFilter').style.display = tab === 'operator_results' ? 'inline' : 'none';

            loadData();
        }

        function sortBy(column) {
            if (currentSort === column) {
                currentOrder = currentOrder === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort = column;
                currentOrder = 'asc';
            }
            currentPage = 0;
            loadData();
        }

        function goToPage(page) {
            currentPage = page;
            loadData();
        }

        // Event listeners
        document.getElementById('search').addEventListener('input', () => {
            currentPage = 0;
            setTimeout(loadData, 300);
        });

        document.getElementById('typeFilter').addEventListener('change', () => {
            currentPage = 0;
            loadData();
        });

        document.getElementById('limit').addEventListener('change', () => {
            currentPage = 0;
            loadData();
        });

        // Initial load
        loadStats();
        loadData();
    </script>
</body>
</html>
